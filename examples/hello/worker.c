#include <assert.h>
#include <string.h>
#include <stdlib.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <errno.h>

#include <sys/types.h>
#include <unistd.h>

#include "etty.h"

const uint8_t favicon[] = {
	0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x20, 0x20,
	0x02, 0x00, 0x01, 0x00, 0x01, 0x00, 0x30, 0x01,
	0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00,
	0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x40, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe3, 0x8c,
	0x4b, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xf7, 0xf7, 0xff, 0xf1, 0xf7,
	0xf7, 0xc7, 0xfa, 0xf3, 0xe7, 0xaf, 0xfb, 0x7c,
	0x9f, 0x6f, 0xfd, 0xbf, 0x7e, 0xdf, 0xfe, 0xbf,
	0x7e, 0xbf, 0xff, 0x1c, 0x1c, 0x7f, 0xf9, 0xf3,
	0x67, 0xcf, 0xe6, 0x77, 0x77, 0x33, 0x9f, 0x97,
	0x74, 0xfc, 0xe6, 0x74, 0x97, 0x33, 0xf9, 0xf3,
	0xe7, 0xcf, 0xff, 0x1c, 0x9c, 0x7f, 0xfe, 0xbf,
	0x7e, 0xbf, 0xfd, 0xbf, 0xfe, 0xdf, 0xfb, 0x7f,
	0xff, 0x6f, 0xfa, 0xff, 0xff, 0xaf, 0xf1, 0xff,
	0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xf7, 0xf7, 0xff, 0xf1, 0xf7,
	0xf7, 0xc7, 0xfa, 0xf3, 0xe7, 0xaf, 0xfb, 0x7c,
	0x9f, 0x6f, 0xfd, 0xbf, 0x7e, 0xdf, 0xfe, 0xbf,
	0x7e, 0xbf, 0xff, 0x1c, 0x1c, 0x7f, 0xf9, 0xf3,
	0x67, 0xcf, 0xe6, 0x77, 0x77, 0x33, 0x9f, 0x97,
	0x74, 0xfc, 0xe6, 0x74, 0x97, 0x33, 0xf9, 0xf3,
	0xe7, 0xcf, 0xff, 0x1c, 0x9c, 0x7f, 0xfe, 0xbf,
	0x7e, 0xbf, 0xfd, 0xbf, 0xfe, 0xdf, 0xfb, 0x7f,
	0xff, 0x6f, 0xfa, 0xff, 0xff, 0xaf, 0xf1, 0xff,
	0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
};

static bool task(struct etty_header *header, const char *source_address)
{
	if(!etty_read_and_parse_headers(header)) {
		return false;
	}

	// Write our headers
	if(!strcmp(header->path, "/favicon.ico")) { 
		// Favicon
		printf("HTTP/1.1 200 OK\r\n");
		printf("Content-Type: image/x-icon\r\n");
		printf("Content-Length: %d\r\n", (int)sizeof(favicon));
		printf("Connection: close\r\n");
		printf("\r\n");
		fwrite(favicon, sizeof(favicon), 1, stdout);
		return true;
	} else if(!strcmp(header->path, "/")) {
		printf("HTTP/1.1 200 OK\r\n");
		printf("Content-Type: text/html; charset=utf-8\r\n");
		printf("Connection: close\r\n");
		printf("\r\n");

		// Contents
		printf(
			"<html>\r\n"
			"<head>\r\n"
				"<title>Test page</title>\r\n"
			"</head>\r\n"
			"<body>\r\n"
			"<center>\r\n"
		);
		printf("<h1>It might have worked!</h1>\r\n");
		printf("<p>This page brought to you by the number %d.</p>\r\n", getpid());
		printf("<p>Your IP is: %s</p>\r\n", source_address);
		printf("<p>You requested the URL <b>%s</b>.</p>\r\n", header->path);
		const char *hdr_host = etty_find_header_field(header, "Host");
		if(hdr_host == NULL) { hdr_host = "(not provided)"; }
		printf("<p>Host: <b>%s</b></p>\r\n", hdr_host);
		printf("<h2>List of headers:</h2>\r\n");
		printf("<ul style=\"display: block; width: 40%%; text-align: left\">\r\n");
		for(size_t i = 0; i < header->pair_count; i++) {
			struct etty_pair *p = &header->pairs[i];
			printf("<li><pre style=\"display: inline\">%s = %s</pre></li>\r\n", p->key, p->value);
		}
		printf("</ul>\r\n");

		printf(
			"<hr />\r\n"
			"<p>c-runo application server</p>\r\n"
			"</center>\r\n"
			// useful stress test
			//"<script>window.location.reload();</script>\r\n"
			"</body>\r\n"
			"</html>\r\n"
		);
		return true;
	}

	etty_generate_error(404, "not found");
	fprintf(stderr, "not found: \"%s\"\n", header->path);
	return false;
}

int task_main(int argc, char *argv[])
{
	(void)argc;
	(void)argv;

	struct etty_header header_base = {.pair_count = 0};

	fprintf(stderr, "START\n");
	task(&header_base, argv[1]);
	etty_clear_header(&header_base);
	fflush(stdout);
	fprintf(stderr, "DOOT\n");
	return 0;
}

